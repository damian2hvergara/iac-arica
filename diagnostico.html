<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Im√°genes - Import American Cars</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f7; color: #1d1d1f; padding: 40px 20px; }
        h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .subtitle { color: #6e6e73; margin-bottom: 40px; font-size: 15px; }
        .card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .vehicle-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .vehicle-name { font-size: 18px; font-weight: 600; }
        .vehicle-status { padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: 600; }
        .status-stock { background: #dcfce7; color: #166534; }
        .status-transit { background: #dbeafe; color: #1e40af; }
        .status-reserve { background: #fef3c7; color: #92400e; }
        .raw-data { background: #f5f5f7; border-radius: 8px; padding: 12px 16px; font-family: monospace; font-size: 13px; color: #515154; word-break: break-all; margin-bottom: 16px; }
        .images-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .img-item { position: relative; border-radius: 10px; overflow: hidden; background: #e5e5e7; aspect-ratio: 4/3; }
        .img-item img { width: 100%; height: 100%; object-fit: cover; }
        .img-item .img-status { position: absolute; bottom: 0; left: 0; right: 0; padding: 6px 8px; font-size: 11px; font-weight: 600; text-align: center; }
        .img-ok { background: rgba(22, 163, 74, 0.85); color: white; }
        .img-error { background: rgba(220, 38, 38, 0.85); color: white; }
        .img-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: #86868b; font-size: 12px; padding: 8px; text-align: center; }
        .no-images { color: #86868b; font-size: 14px; padding: 20px; text-align: center; background: #f5f5f7; border-radius: 8px; }
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 40px; }
        .stat { background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .stat-num { font-size: 36px; font-weight: 700; }
        .stat-label { font-size: 12px; color: #6e6e73; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 4px; }
        .loading { text-align: center; padding: 60px; color: #6e6e73; font-size: 16px; }
        .url-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-bottom: 8px; }
        .url-full { background: #dcfce7; color: #166534; }
        .url-relative { background: #fef3c7; color: #92400e; }
        .url-empty { background: #fee2e2; color: #991b1b; }
        .fixed-badge { background: #dbeafe; color: #1e40af; }
        h2 { font-size: 14px; font-weight: 600; color: #6e6e73; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico de Im√°genes</h1>
    <p class="subtitle">Verifica el estado de las im√°genes de todos tus veh√≠culos en Supabase + Cloudinary</p>

    <div id="app"><div class="loading">‚è≥ Conectando con Supabase...</div></div>

    <script>
    const SUPABASE_URL = 'https://cflpmluvhfldewiitymh.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbHBtbHV2aGZsZGV3aWl0eW1oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MTM0NzcsImV4cCI6MjA4MDk4OTQ3N30.of3ic6N1Y3U5dtSmzKzkTdvfvRnqYjqFI2fglmibaiM';
    const CLOUD_NAME = 'df2gprqhp';

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function normalizeUrl(raw) {
        if (!raw || typeof raw !== 'string') return null;
        const t = raw.trim();
        if (t.startsWith('http://') || t.startsWith('https://')) return { url: t, type: 'full' };
        if (t.length > 0) return {
            url: `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/${t}`,
            type: 'relative'
        };
        return null;
    }

    function parseImages(raw) {
        if (!raw) return [];
        let arr = raw;
        if (typeof raw === 'string') {
            try { arr = JSON.parse(raw); } catch { arr = [raw]; }
        }
        if (!Array.isArray(arr)) return [];
        return arr.map(normalizeUrl).filter(Boolean);
    }

    async function run() {
        const { data, error } = await client
            .from('vehicles')
            .select('id, name, status, images')
            .order('created_at', { ascending: false });

        if (error) {
            document.getElementById('app').innerHTML = `<div class="card" style="color:red;">‚ùå Error Supabase: ${error.message}</div>`;
            return;
        }

        let totalVehicles = data.length;
        let totalImages = 0;
        let emptyVehicles = 0;
        let relativeUrls = 0;
        let fullUrls = 0;

        data.forEach(v => {
            const imgs = parseImages(v.images);
            if (imgs.length === 0) emptyVehicles++;
            imgs.forEach(i => {
                totalImages++;
                if (i.type === 'relative') relativeUrls++;
                else fullUrls++;
            });
        });

        let html = `
            <div class="summary">
                <div class="stat">
                    <div class="stat-num">${totalVehicles}</div>
                    <div class="stat-label">Veh√≠culos</div>
                </div>
                <div class="stat">
                    <div class="stat-num" style="color:${totalImages>0?'#166534':'#991b1b'}">${totalImages}</div>
                    <div class="stat-label">Im√°genes totales</div>
                </div>
                <div class="stat">
                    <div class="stat-num" style="color:${emptyVehicles>0?'#991b1b':'#166534'}">${emptyVehicles}</div>
                    <div class="stat-label">Sin im√°genes</div>
                </div>
                <div class="stat">
                    <div class="stat-num" style="color:${relativeUrls>0?'#b45309':'#166534'}">${relativeUrls}</div>
                    <div class="stat-label">Rutas relativas<br><small>(se auto-corrigen)</small></div>
                </div>
                <div class="stat">
                    <div class="stat-num" style="color:#166534">${fullUrls}</div>
                    <div class="stat-label">URLs completas</div>
                </div>
            </div>
        `;

        data.forEach(v => {
            const imgs = parseImages(v.images);
            const statusClass = `status-${v.status || 'stock'}`;
            const statusLabel = { stock: 'En Stock', transit: 'En Tr√°nsito', reserve: 'Reservar' }[v.status] || v.status;

            html += `<div class="card">
                <div class="vehicle-header">
                    <div class="vehicle-name">${v.name}</div>
                    <span class="vehicle-status ${statusClass}">${statusLabel}</span>
                </div>`;

            // Raw data
            html += `<h2>Valor raw en Supabase</h2>
                <div class="raw-data">${JSON.stringify(v.images)}</div>`;

            if (imgs.length === 0) {
                html += `<div class="no-images">‚ö†Ô∏è Sin im√°genes ‚Äî el campo <code>images</code> est√° vac√≠o o null</div>`;
            } else {
                html += `<h2>Im√°genes procesadas (${imgs.length})</h2><div class="images-grid">`;
                imgs.forEach((img, i) => {
                    const badge = img.type === 'relative'
                        ? `<span class="url-badge url-relative">Ruta relativa ‚Üí auto-corregida</span>`
                        : `<span class="url-badge url-full">URL completa ‚úì</span>`;

                    html += `<div>
                        ${badge}
                        <div class="img-item">
                            <img src="${img.url}"
                                onload="this.nextElementSibling.className='img-status img-ok'; this.nextElementSibling.textContent='‚úì Carga OK'"
                                onerror="this.nextElementSibling.className='img-status img-error'; this.nextElementSibling.textContent='‚úó No carga'">
                            <div class="img-status" style="background:rgba(0,0,0,0.4);color:white;">Verificando...</div>
                        </div>
                        <div style="font-size:11px;color:#86868b;margin-top:4px;word-break:break-all;padding:0 2px">${img.url.slice(0,80)}${img.url.length>80?'‚Ä¶':''}</div>
                    </div>`;
                });
                html += `</div>`;
            }
            html += `</div>`;
        });

        document.getElementById('app').innerHTML = html;
    }

    run();
    </script>
</body>
</html>
